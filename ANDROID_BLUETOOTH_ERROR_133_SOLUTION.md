# Решение ошибки Android Bluetooth 133 (GATT_ERROR)

## Описание проблемы
Ошибка 133 в Android Bluetooth - это `GATT_ERROR`, который возникает при проблемах с подключением к GATT серверу устройства. Это одна из самых распространенных ошибок при работе с Bluetooth Low Energy (BLE) устройствами.

## Причины возникновения
1. **Устройство недоступно** - устройство выключено или находится вне зоны действия
2. **Проблемы с разрешениями** - недостаточно разрешений для подключения
3. **Таймаут подключения** - устройство не отвечает в течение установленного времени
4. **Конфликт подключений** - устройство уже подключено к другому приложению
5. **Проблемы с GATT сервером** - устройство не может установить GATT соединение

## Внесенные улучшения

### 1. Улучшенная обработка ошибок подключения
- Добавлена специальная обработка для Android ошибки 133
- Улучшены сообщения об ошибках с конкретными рекомендациями
- Добавлены таймауты для подключения (15 секунд + 20 секунд общий таймаут)

### 2. Метод повторного подключения
- Добавлен метод `reconnectToDevice()` для повторных попыток подключения
- Автоматическое отключение перед повторным подключением
- Задержка в 2 секунды между отключением и повторным подключением

### 3. Улучшенный UI
- Добавлена кнопка "Повторить" для повторного подключения
- Индикатор загрузки во время подключения
- Более информативные сообщения об ошибках

### 4. Улучшенная обработка состояний
- Проверка статуса подключения перед попыткой подключения
- Лучшее отслеживание состояний подключения
- Задержка перед получением сервисов (2 секунды)

## Как использовать

### Обычное подключение
```dart
// Нажмите кнопку "Подключить" на устройстве
context.read<BluetoothBloc>().add(ConnectToDeviceEvent(deviceId));
```

### Повторное подключение
```dart
// Нажмите кнопку "Повторить" если первое подключение не удалось
context.read<BluetoothBloc>().add(ReconnectToDeviceEvent(deviceId));
```

## Рекомендации для пользователей

### При возникновении ошибки 133:
1. **Убедитесь, что устройство включено** и находится рядом (в пределах 1-2 метров)
2. **Перезапустите Bluetooth** на устройстве Android
3. **Попробуйте подключиться снова** через несколько секунд
4. **Используйте кнопку "Повторить"** для автоматического переподключения
5. **Проверьте, что устройство не подключено** к другому приложению

### Дополнительные советы:
- Убедитесь, что у приложения есть все необходимые разрешения
- Попробуйте перезапустить приложение
- Проверьте, что устройство поддерживает BLE
- Убедитесь, что устройство находится в режиме сопряжения

## Технические детали

### Код ошибки 133
```dart
if (e.toString().contains('android-code: 133')) {
  errorMessage = 'Ошибка подключения к устройству: GATT_ERROR (133) - Устройство недоступно или не отвечает. Попробуйте:\n'
      '1. Убедитесь, что устройство включено и находится рядом\n'
      '2. Перезапустите Bluetooth на устройстве\n'
      '3. Попробуйте подключиться снова через несколько секунд';
}
```

### Таймауты подключения
```dart
await device.connect(
  timeout: const Duration(seconds: 15),
  autoConnect: false,
).timeout(
  const Duration(seconds: 20),
  onTimeout: () {
    throw Exception('Таймаут подключения к устройству');
  },
);
```

## Мониторинг и отладка

Приложение теперь предоставляет подробные логи для отладки:
- Статус подключения в реальном времени
- Детальная информация об ошибках
- Время выполнения операций
- Информация о найденных сервисах и характеристиках

Проверьте вкладку "Логи" для получения дополнительной информации о проблемах подключения.
